<?xml version='1.0' encoding='utf-8' ?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/></head><body><p><link rel="stylesheet" type="text/css" href="http://klarschiff-test-sn/backend_sn/styles/styles.css"></p><p class="doctitle">Administrationshandbuch</p><p class="docsubtitle">Klarschiff Backend</p><p>erstellt von</p><ul><li>Stefan Audersch</li></ul><p><strong>Änderungsübersicht</strong></p><table><tr class="tableHeader"><td>Version </td><td>Datum </td><td>Bearbeiter </td><td>Beschreibung </td></tr><tr><td>1.0 </td><td>10.2011 </td><td>Stefan Audersch </td><td></td></tr><tr><td>2.0 </td><td>10.2015 </td><td>BFPI </td><td>Komplette Überarbeitung </td></tr></table><p><strong>Klarschiff</strong> ist eine Webanwendung. Sie wurde mithilfe der plattformunabhängigen objektorientierten Programmiersprache <em>Java</em> entwickelt. Grundlage für die Datenhaltung bildet eine PostgresSQL-Datenbank, die in ein Geoinformationssystem eingebunden werden kann. Zusätzliche Anwendungen wurden in der Programmiersprache <em>Ruby</em> erstellt. <strong>Klarschiff</strong> wird unter der <a href="https://de.wikipedia.org/wiki/GNU_General_Public_License">GNU General Public License</a> veröffentlicht. Die Quellen findet man unter <a href="https://github.com/bfpi">https://github.com/bfpi</a>.</p><p><strong>Inhaltsverzeichnis</strong></p><ol class="toc" style="list-style: none;"><li><a href="#voraussetzungen">Voraussetzungen</a></li><li><a href="#software">Software</a><ol style="list-style: none;"><li><a href="#java">1. Java - Laufzeitumgebung</a></li><li><a href="#datenbank">2. Datenbank</a><ol style="list-style: none;"><li><a href="#backend">2.1 Backend</a></li><li><a href="#zufi">2.2 Zuständigkeitsfinder</a></li><li><a href="#frontend">2.3 Frontend</a></li><li><a href="#standortsuche">2.4 Standortsuche</a></li></ol></li><li><a href="#webserver">3. Webserver</a><ol style="list-style: none;"><li><a href="#apache">3.1 Webserver Apache</a><ol style="list-style: none;"><li><a href="#konfigurationapache">3.1.1 Konfiguration:</a></li></ol></li><li><a href="#tomcat">3.2 Webserver Apache Tomcat</a><ol style="list-style: none;"><li><a href="#konfigurationtomcat">3.2.1 Konfiguration</a></li></ol></li><li><a href="#konfigurationapachefuerklarschiff">3.3 Konfiguration Apache für Klarschifff</a></li></ol></li><li><a href="#php">4. PHP</a></li><li><a href="#geoserver">5. GeoServer</a><ol style="list-style: none;"><li><a href="#geoservereinstellungen">5.1 Einstellungen</a></li><li><a href="#geoserverkonfiguration">5.2 Konfiguration</a><ol style="list-style: none;"><li><a href="#geoserverarbeitsbereich">5.2.1 Arbeitsbereich</a></li><li><a href="#geoserverdatenspeicher">5.2.2 Datenspeicher</a></li><li><a href="#geoserverlayer">5.2.3 Layer</a></li></ol></li></ol></li><li><a href="#a6Solr">6 Solr</a></li><li><a href="#ruby">7. Ruby</a></li><li><a href="#github">8. GitHub (Git)</a></li><li><a href="#maven">9. Maven</a></li><li><a href="#nodejs">10. Nodejs</a></li><li><a href="#openldap">11. OpenLDAP</a></li></ol></li><li><a href="#klarschiff_frontend">Klarschiff-Frontend</a><ol style="list-style: none;"><li><a href="#konfigurationsdateienfontend">1. Konfigurationsdateien Frontend</a><ol style="list-style: none;"><li><a href="#startphp">1.1 start.php</a></li><li><a href="#urlsphp">1.2 urls.php</a></li><li><a href="#configjsphp">1.3 config.js.php</a></li><li><a href="#mapphp">1.4 map.php</a></li></ol></li></ol></li><li><a href="#klarschifffrontendmobil">Klarschiff Frontend mobil</a></li><li><a href="#klarschiff_backend">Klarschiff-Backend</a><ol style="list-style: none;"><li><a href="#settingproperties">1. Setting.properties</a><ol style="list-style: none;"><li><a href="#kontextderanwendung">1.1 Kontext der Anwendung</a></li><li><a href="#serverurlsfueremails">1.2 Server URLs für E-Mails</a></li><li><a href="#mailversand">1.3 Mailversand</a></li><li><a href="#encodingfueremailmailto">1.4 Encoding für E-Mail-"mailto"</a></li><li><a href="#einstellungendatenbankbackend">1.5 Einstellungen Backend-Datenbank</a></li><li><a href="#einstellungendatenbankfrontend">1.6 Einstellungen Frontend-Datenbank</a></li><li><a href="#datenbankskriptefuerdblinkundfrontenddatenbank">1.7 Datenbankskripte für dblink und Frontend-Datenbank</a></li><li><a href="#dateisystempfadundurlzudenfotos">1.8 Dateisystempfad und URL zu den Fotos</a></li><li><a href="#automatischejobs">1.9 Automatische Jobs</a></li><li><a href="#tmsfuerkarte">1.10 TMS(Tile Map Service) für Karte</a><ol style="list-style: none;"><li><a href="#kartendarstellungmitopenlayers">1.10.1 Kartendarstellung mit OpenLayers</a></li><li><a href="#darstellungeinesvorgangsbzwdesortesineinemexternensystem">1.10.2 Darstellung eines Vorgangs bzw. des Ortes in einem externen System</a></li><li><a href="#wmsmitzusaetzlichenpoifuerkarte">1.10.3 WMS(Web Map Service) mitzusätzlichen POI(Points of Interest) für Karte</a></li><li><a href="#wfsmitvorgaengenfuerkarte">1.10.4 WFS(Web Feature Service) mit Vorgängen für Karte</a></li><li><a href="#wfsfuerzustaendigkeitsfinder">1.10.5 WFS(Web Feature Service) für Zuständigkeitsfinder</a></li></ol></li><li><a href="#adressensuche">1.11 Adressensuche</a></li><li><a href="#proxy">1.12 Proxy</a></li><li><a href="#ldap">1.13 LDAP(Lightweight Directory Access Protocol)</a></li><li><a href="#a1.14Loginseite">1.14 Loginseite</a></li><li><a href="#a1.15AnzahlUntersttzerbeiIdeen">1.15 Anzahl Unterstützer bei Ideen</a></li><li><a href="#a1.16Fehlermeldungen">1.16 Fehlermeldungen</a></li><li><a href="#a1.17Connector">1.17 Connector</a></li><li><a href="#a1.18Version">1.18 Version</a></li></ol></li></ol></li><li><a href="#import">Import</a><ol style="list-style: none;"><li><a href="#stadtteile">1. Stadtteile</a></li><li><a href="#adressen">2. Adressen</a></li><li><a href="#kategorien">3. Kategorien</a></li><li><a href="#wfs">4. WFS(Web Feature Service)</a></li><li><a href="#bewirtschafter">5. Bewirtschafter</a></li></ol></li><li><a href="#administration">Administration</a></li></ol><h2 id="voraussetzungen">Voraussetzungen</h2><p>Die folgende Software muss in Abhängigkeit des verwendeten Betriebssystems installiert sein.</p><ul><li><strong>PostgreSQL</strong>-Datenbank mit der Erweiterung <strong>PostGIS</strong> für geographische Objekte und Funktionen</li><li><strong>Webserver</strong> z.B. Apache</li><li>Webserver mit der Spezifikation für Java Servlets und Java Server Pages <strong>Apache Tomcat</strong></li><li><strong>Solr</strong> Java Web-Applikation, welche für eine Adressen- und Standortsuche genutzt wird</li><li>Laufzeitumgebung <strong>Java</strong></li><li>Programmiersprache <strong>Ruby</strong> für einen Datenimport und zusätzliche Anwendungen</li><li><strong>Git</strong> Software zur verteilten Versionsverwaltung von Dateien (unter Microsoft Windows <strong>GitHub Desktop</strong>)</li><li><strong>OpenLDAP</strong> Bei Verwendung eines LDAP-Servers. Es kann auch eine <acronym title="LDAP Data Interchange Format">LDIF</acronym>-Datei genutzt werden. Eine Einbindung in eine Active Directory (AD) Umgebung ist theoretisch möglich. Dieses wurde aber noch nicht getestet.</li><li><strong>Nodejs</strong> Serverseitige Plattform zum Betrieb von Netzwerkanwendungen. Basiert auf der Javascript-Laufzeitumgebung.</li><li><strong>PHP</strong> Skriptsprache zur Erstellung von dynamischen Webseiten oder Webanwendungen</li><li><strong>Mailserver</strong> Das <strong>Backend</strong> muss einen Mailserver erreichen können, da es selbstständig E-Mails generiert.</li><li>Mapserver <strong>Geoserver</strong> zur Bereitstellung des <acronym title="Web Feature Service">WFS</acronym>. Stellt keine eigenen Geodaten zur Verfügung.</li></ul><p>Alle im weiteren Kontext verwendeten Versionsangaben zur verwendeten Software beziehen sich auf deren Stand zum Redaktionszeitpunkt dieser Beschreibung. Der Anwender sollte Kenntnisse über die Verfahren der Softwareinstallation für das von ihm verwendete Betriebssystem verfügen.</p><h2 id="software">Software</h2><p><strong>Hinweis</strong>: Bei der Installation unter dem Betriebssystem <strong>MS Windows</strong> sollte darauf geachtet werden, dass die Software <strong>nicht</strong> im Standardverzeichnis für Programme installiert wird. Im Standardverzeichnis wird das Schreiben von Dateien teilweise durch das <acronym title="User Account Control">UAC</acronym> (Benutzerkontensteuerung) verhindert bzw. erschwert. Ein Schreiben von Dateien ist aber notwendig.</p><h3 id="java">1. Java &#8211; Laufzeitumgebung</h3><p>Es muss mindestens die Version 7 des <strong>JDK Servers</strong> (Java SE Development Kit) installiert sein. Die aktuellste Version des JDK &#8211; Servers findet man unter <a href="http://www.oracle.com/technetwork/java/javase/downloads/index.html">http://www.oracle.com/technetwork/java/javase/downloads/index.html</a>.</p><p>Zum Betreiben von <strong>Klarschiff</strong> und des <a href="#geoserver"><strong>Geoservers</strong></a> wird nur <strong>Java Runtime Environment</strong> (JRE) benötigt. Will man das Build-Management-Tool <a href="#maven"><strong>Maven</strong></a> nutzen, benötigt man das komplette <strong>Java SE Development Kit</strong> (JDK), welches auch die JRE-Umgebung enthält.</p><p>Wird auf der Willkommenseite des <a href="#geoserver"><strong>Geoservers</strong></a> den Hinweis &#8222;Keine starke Kryptographie verfügbar&#8221; angezeigt findet man unter <a href="http://docs.geoserver.org/latest/en/user/production/java.html#java-policyfiles">http://docs.geoserver.org/latest/en/user/production/java.html#java-policyfiles</a> eine Anleitung zur Nachinstallation der entsprechen JAR-Dateien.</p><h3 id="datenbank">2. Datenbank</h3><p>Das Aufsetzen der Datenbank beginnt mit der Installation der <strong>PostgreSQL</strong>-Datenbank ab der Version 9.4 mit <strong>PostGIS</strong> ab der Version 2.1. Für die Administration der Datenbank kann die grafische Oberfläche <strong>pgAdmin III</strong> installiert werden.</p><p>Die aktuelle <strong>PostgreSQL</strong>-Datenbank kann unter <a href="http://www.postgresql.org/download/">http://www.postgresql.org/download/</a> heruntergeladen werden.</p><p><strong>Hinweis</strong>: Für das Betriebssystem <strong>Windows</strong> ist eine grafische Installationsroutine vorhanden. Hier wird <strong>pgAdmin III</strong> automatisch mit installiert. Weiterhin ist nach der Installation von <strong>PostgreSQL</strong> ein grafisches Tool zum Installieren von zusätzlicher Software für die Datenbank vorhanden. Unter <em>Start -&gt; Alle Programme -&gt; PostgreSQL 9.4</em> ist dies der <strong>Application Stack Builder</strong>. Dieser muss mit Administratorrechten gestartet werden. Nach dem Start und der Auswahl der lokalen Datenbank findet man unter dem Punkt <em>Spatial Extensions</em> die <strong>PostGIS</strong>-Erweiterung in der Version 2.1. Mit der Aktivierung der Checkbox wird die entsprechende Erweiterung installiert.</p><p>Nach der Installation von <strong>PostgreSQL</strong> mit <strong>PostGIS</strong> müssen spezielle Datenbanknutzer und Datenbanken angelegt werden.</p><h4 id="backend">2.1 Backend</h4><ol><li><strong>Datenbanknutzer:</strong> <em>klarschiff_backend</em> mit dem <strong>Passwort:</strong> <em>klarschiff_backend</em></li><li><strong>Datenbank:</strong> <em>klarschiff_backend</em> mit dem <strong>Eigentümer:</strong> <em>klarschiff_backend</em></li></ol><h4 id="zufi">2.2 Zuständigkeitsfinder</h4><ol><li><strong>Datenbanknutzer:</strong> <em>zufi</em> mit dem <strong>Passwort:</strong> <em>zufi</em></li><li><strong>Datenbank:</strong> <em>zufi</em> mit dem <strong>Eigentümer:</strong> <em>zufi</em></li></ol><h4 id="frontend">2.3 Frontend</h4><ol><li><strong>Datenbanknutzer:</strong> <em>klarschiff_frontend</em> mit dem <strong>Passwort:</strong> <em>klarschiff_frontend</em></li><li><strong>Datenbank:</strong> <em>klarschiff_frontend</em> mit dem <strong>Eigentümer:</strong> <em>klarschiff_frontend</em></li></ol><p>Die Datenbank <em>klarschiff_frontend</em> wird von der Datenbank <em>klarschiff_backend</em> initialisiert. Weiterhin werden die Daten der Datenbank <em>klarschiff_backend</em> während des Betriebs von der Datenbank <em>klarschiff_frontend</em> publiziert. Um dieses zu gewährleisten, muss die Erweiterung <em>dblink</em> eingerichtet werden. Dieses erfolgt innerhalb der Datenbank <em>klarschiff_backend</em> mit</p><pre><code>CREATE EXTENSION dblink;
</code></pre><p>Um eine Verbindung zum <strong>PostGIS</strong> herzustellen, muss innerhalb der Datenbanken <em>klarschiff_backend</em> <strong><ins>und</ins></strong> <em>klarschiff_frontend</em> die Erweiterung bekanntgegeben werden. Dieses erfolgt jeweils mit:</p><pre><code>CREATE EXTENSION postgis;
</code></pre><h4 id="standortsuche">2.4 Standortsuche</h4><ol><li><strong>Datenbanknutzer:</strong> <em>standortsuche</em> mit dem <strong>Passwort:</strong> <em>standortsuche</em></li><li><strong>Datenbank:</strong> <em>standortsuche</em> mit dem <strong>Eigentümer:</strong> <em>standortsuche</em></li></ol><p>Nach dem Anlegen der Grundlagen für die Standortsuche muss das SQL-Skript <em>standortsuche.sql</em> ausgeführt werden. Es werden die notwendigen Tabellen angelegt. </p><h3 id="webserver">3. Webserver</h3><p><strong>Hinweis:</strong> Bei der Installation unter dem Betriebssystem <strong>MS Windows</strong> kann die aktuellste Version des Softwarepakets <strong>XAMPP</strong> genutzt werden. Es besteht die Möglichkeit, die Installation der Datenbank <strong>MySQL</strong>, des FTP-Servers <strong>FileZilla</strong> und des Mailservers <strong>Mercury</strong> abzuwählen. Es werden dann die Webserver <a href="#apache"><strong>Apache</strong></a> und <a href="#tomcat"><strong>Apache Tomcat</strong></a> sowie die Skriptsprache <a href="#php"><strong>PHP</strong></a> installiert.</p><h4 id="apache">3.1 Webserver Apache</h4><p>Im Zusammenhang mit <strong>Klarschiff</strong> wird der frei verfügbare Webserver <strong>Apache</strong> ab der Version 2.4 genutzt.</p><p>Der Webserver <strong>Apache</strong> sollte an folgenden Ports laufen.</p><table><tr class="tableHeader"><td>Port </td><td>Nummer </td></tr><tr><td>Main </td><td>80 </td></tr><tr><td>SSL </td><td>443 </td></tr></table><p>Aktuelle Informationen zur Installation des Webservers <strong>Apache</strong> findet man unter <a href="http://httpd.apache.org/download.cgi">http://httpd.apache.org/download.cgi</a>.</p><h5 id="konfigurationapache">3.1.1 Konfiguration:</h5><p>Aktivierung der Module:</p><ul><li>proxy</li><li>rewrite</li><li>headers</li><li>proxy_ajp</li><li>proxy_http</li><li>deflate</li></ul><h4 id="tomcat">3.2 Webserver Apache Tomcat</h4><p>Für den Betrieb des <strong>Backends</strong> von <strong>Klarschiff</strong> ist eine Installation des Webservers <strong>Apache Tomcat</strong> ab der Version 7 notwendig.<br/>Der Webserver sollte an folgenden Ports laufen:</p><table><tr class="tableHeader"><td>Port </td><td>Nummer </td></tr><tr><td>Main </td><td>8005 </td></tr><tr><td>AJP </td><td>8009 </td></tr><tr><td>HTTP </td><td>8080 </td></tr></table><p>Aktuelle Informationen zu Versionen und eine Dokumentation findet man unter <a href="https://tomcat.apache.org/index.html">https://tomcat.apache.org/index.html</a>.</p><h5 id="konfigurationtomcat">3.2.1 Konfiguration</h5><p><strong>Arbeitsspeichervergrößerung:</strong></p><p>Bei der Vergrößerung des Arbeitsspeichers ist der vorhandene physikalische Speicher des Servers zu beachten. Es kann nicht mehr Speicher frei gegeben werden als vorhanden ist.</p><p><strong>Windows:</strong> Aufruf des Programms &#8222;Configure Tomcat&#8221; unter <em>Start -&gt; Alle Programme -&gt; Apache Tomcat x.0</em>. Auf der Registerkarte &#8222;Java&#8221; im Feld &#8222;Initial memory pool&#8221; den Wert 1024 und im Feld &#8222;Maximum memory pool&#8221; den Wert 2048 eintragen. Im Feld &#8222;Java Options&#8221; sind die folgenden Parameter einzutragen:</p><pre><code>-Djava.awt.headless=true
-XX:PermSize=256m
-XX:MaxPermSize=512m
-XX:+CMSClassUnloadingEnabled
-XX:+UseConcMarkSweepGC
-Dfile.encoding=UTF8
</code></pre><p><strong>Linux:</strong> In der Datei /etc/default/tomcatx den Eintrag auf</p><pre><code>JAVA_OPTS="-Djava.awt.headless=true -Xms1024m -Xmx2048m -XX:PermSize=256m -XX:MaxPermSize=512m 
-XX:+CMSClassUnloadingEnabled -XX:+UseConcMarkSweepGC -Dfile.encoding=UTF8"
</code></pre><p>ändern.</p><p>Für <strong>alle</strong> Betriebssysteme muss der AJP-Connector in der Datei Server.xml aktiviert werden.</p><pre><code>&lt; Connector address="127.0.0.1" port="8009" protocol="AJP/1.3" packetSize="65536" redirectPort="8443" /&gt;
</code></pre><h4 id="konfigurationapachefuerklarschiff">3.3 Konfiguration Apache für Klarschifff</h4><p>Für die Herstellung der Verbindung zwischen den Webservern <a href="#apache"><strong>Apache</strong></a> und <a href="apachetomcat"><strong>Apache Tomcat</strong></a> wird eine Datei <em>klarschiff.conf</em> genutzt. In ihr befinden sich alle Konfigurationsparameter, die für die Zusammenarbeit von <strong>Klarschiff</strong> mit den Webservern und dem <a href="#geoserver"><strong>Geoserver</strong></a> benötigt werden. Diese Konfigurationsdatei muss beim Start des Webservers <a href="#apache"><strong>Apache</strong></a> mit geladen werden. Der Inhalt und die Verfahren zur Aktivierung dieser Datei sind abhängig vom verwendeten Betriebssystem.</p><p>Weiterleitungen für Zugriffe auf Geodienste (<strong>GeoServer</strong>) jeweils via AJP auf das entsprechende GeoServer-Skript)<br/>Die folgenden Angaben korrespondieren auch mit dem Inhalt der Datei <em>urls.php</em>. Das &#8222;.../klarschiff/...&#8221; in den URIs bezieht sich auf die URI des Namensraumes für den Arbeitsbereich im <a href="#geoserver"><strong>Geoserver</strong></a> </p><pre><code>&lt;Location /ows/klarschiff/ows&gt;
  ProxyPass           ajp://localhost:8009/geoserver/klarschiff/ows
  ProxyPassReverse    ajp://localhost:8009/geoserver/klarschiff/ows
  
  # serverseitige Komprimierung der ausgelieferten Inhalte
  SetOutputFilter DEFLATE
  BrowserMatch \bMSIE !no-gzip !gzip-only-text/html
  SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png)$ no-gzip dont-vary
  Header append Vary User-Agent env=!dont-vary
&lt;/Location&gt;

&lt;Location /ows/klarschiff/wfs&gt;
  ProxyPass           ajp://localhost:8009/geoserver/klarschiff/wfs
  ProxyPassReverse    ajp://localhost:8009/geoserver/klarschiff/wfs

  # serverseitige Komprimierung der ausgelieferten Inhalte
  SetOutputFilter DEFLATE
  BrowserMatch \bMSIE !no-gzip !gzip-only-text/html
  SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png)$ no-gzip dont-vary
  Header append Vary User-Agent env=!dont-vary
&lt;/Location&gt;

&lt;Location /ows/klarschiff/wms&gt;
  ProxyPass           ajp://localhost:8009/geoserver/klarschiff/wms
  ProxyPassReverse    ajp://localhost:8009/geoserver/klarschiff/wms
  
  # serverseitige Komprimierung der ausgelieferten Inhalte
  SetOutputFilter DEFLATE
  BrowserMatch \bMSIE !no-gzip !gzip-only-text/html
  SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png)$ no-gzip dont-vary
  Header append Vary User-Agent env=!dont-vary
&lt;/Location&gt;

</code></pre><p>&#8222;Rewrite-Regeln&#8221; für Klarschiff<br/>(P: Proxy-Regeln anwenden; QSA: vorhandenen Query-String beibehalten; L: bei Matching keine weiteren Rewrite-Rules mehr prozessieren)</p><p>Nach der Erstellung einer Meldung erhält der Anwender eine E-Mail. Mithilfe der folgenden Regeln erfolgt die Generierung einer URL. Diese URLs werden in einer E-Mail dem Nutzer zur Bestätigung seiner Meldung zur Verfügung gestellt.</p><pre><code>RewriteRule ^.*(missbrauchsmeldungBestaetigung/.*)$ http://localhost:8080/backend/service/$1 [P,QSA,L]
RewriteRule ^.*(unterstuetzerBestaetigung/.*)$      http://localhost:8080/backend/service/$1 [P,QSA,L]
RewriteRule ^.*(vorgangBestaetigung/.*)$            http://localhost:8080/backend/service/$1 [P,QSA,L]
RewriteRule ^.*(vorgangLoeschen/.*)$                http://localhost:8080/backend/service/$1 [P,QSA,L]
</code></pre><p>Hier erfolgt die Übersetzung zum Controller <em>Backend</em> und stellt damit die Verarbeitung der Anfragen vom Frontend sicher.</p><p>Die folgenden Angaben gewährleisten eine Weiterleitung für geschützte Zugriffe auf das Klarschiff-Backend.</p><pre><code>&lt;Location /backend&gt;
    ProxyPass           ajp://localhost:8009/backend
    ProxyPassReverse    ajp://localhost:8009/backend

  # serverseitige Komprimierung der ausgelieferten Inhalte
    SetOutputFilter DEFLATE
    BrowserMatch \bMSIE !no-gzip !gzip-only-text/html
    SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png)$ no-gzip dont-vary
    Header append Vary User-Agent env=!dont-vary
&lt;/Location&gt;

</code></pre><h3 id="php">4. PHP</h3><p>Unter <a href="http://php.net/downloads.php">http://php.net/downloads.php</a> findet man die neuesten Informationen zu den aktuellen Versionen von <strong>PHP</strong>. Bei der <strong>PHP</strong>-Installation ist darauf zu achten, dass die folgenden Erweiterungen installiert und initialisiert sind:</p><ol><li><strong>curl</strong> - Dateiübertragung über verschieden Protokolle</li><li><strong>gd</strong> - Bilder generieren und manipulieren</li><li><strong>pgsql</strong> - Zugriff auf die Datenbank <a href="#datenbank"><strong>PostgreSQL</strong></a></li></ol><p>Einen Überblick über die Konfiguration von <strong>PHP</strong> verschafft der Aufruf der Datei phpinfo.php im Browser. Sind die genannten Erweiterungen nicht aufgeführt müssen sie in der Datei php.ini aktiviert werden. Wurden Änderungen an der php.ini durchgeführt, muss in jedem Fall der Webserver <a href="#apache"><strong>Apache</strong></a> neu gestartet werden.</p><h3 id="geoserver">5. GeoServer</h3><p>Der <strong>GeoServer</strong> benötigt mindestens <strong>Java 7</strong>. Welche Version zur Zeit unterstützt werden findet man unter <a href="http://docs.geoserver.org/latest/en/user/installation/win_binary.html">http://docs.geoserver.org/latest/en/user/installation/win_binary.html</a>. Die notwendigen Dateien für die Installation können von <a href="http://geoserver.org/release/stable/">http://geoserver.org/release/stable/</a> heruntergeladen werden. Unter &#8222;Web Archive&#8221; erfolgt das Herunterladen einer ZIP-Datei. Diese enthält eine Datei <em>geoserver.war</em>. Dieser Servlet Container muss in den vom Betriebssystem abhängigen Verzeichnis (...webapps) für die Anwendungen des Webservers <a href="#tomcat"><strong>Apache Tomcat</strong></a> kopiert werden. Der Webserver installiert dann automatisch den <strong>GeoServer</strong>.</p><h4 id="geoservereinstellungen">5.1 Einstellungen</h4><p>Die Aktualisierung des Kartenservers erfolgt auf dem gleichen Weg. Dabei ist zu beachten, dass der komplette Inhalt des Verzeichnisses <em>..webapps\geoserver</em> überschrieben wird. Alle selbst erstellten Daten gehen dabei verloren. Aus diesem Grund sollte das komplette Verzeichnis <em>data</em> unter dem Verzeichnis <em>..webapps\geoserver</em> verschoben werden. Dazu muss der Webserver <a href="#tomcat"><strong>Apache Tomcat</strong></a> gestoppt werden.</p><p>Bei der Verwendung des Kartenservers <strong>Geoserver</strong> muss der Arbeitsspeicher erweitert werden. Wurde das Verzeichnis <em>data</em> verschoben muss dessen Pfad bekannt gegeben werden.Dieses erfolgt mit der Änderung der Umgebungsvariablen <em>GEOSERVER_DATA_DIR</em>. Dem Webserver <a href="#tomcat"><strong>Apache Tomcat</strong></a> sind dann die folgenden Parameter zu übergeben:</p><ul><li><strong>Windows</strong>: Auf der Registerkarte &#8222;Java&#8221; im Feld &#8222;Initial memory pool&#8221; und im Feld &#8222;Maximum memory pool&#8221; den Wert 8192 eintragen. Die Eingabe der Parameter erfolgt analog der Beschreibung der Einstellungen für den Webserver <a href="#tomcat"><strong>Apache Tomcat</strong></a> auf der Registerkarte &#8222;Java&#8221;.</li></ul><pre><code>-DGEOSERVER_DATA_DIR=\irgendwo\data
-Djava.awt.headless=true
-XX:PermSize=1024m
-XX:MaxPermSize=1024m 
-XX:+CMSClassUnloadingEnabled
-XX:+UseConcMarkSweepGC
-Dfile.encoding=UTF8
</code></pre><ul><li><strong>Linux</strong>: In der Datei /etc/default/tomcatx den Eintrag auf </li></ul><pre><code>JAVA_OPTS="-Djava.awt.headless=true -Xms8192m -Xmx8192m -XX:PermSize=1024m -XX:MaxPermSize=1024m
-XX:+CMSClassUnloadingEnabled -XX:+UseConcMarkSweepGC -DGEOSERVER_DATA_DIR=/irgendwo/data -Dfile.encoding=UTF8"
</code></pre><p>ändern.</p><h4 id="geoserverkonfiguration">5.2 Konfiguration</h4><p>Im <strong>Geoserver</strong> werden Layer konfiguriert, die mittels verschiedener Protokolle abgerufen werden können. Die Layer erhalten ihre Daten aus Datenspeichern. Layer und Datenspeicher werden Arbeitsbereichen zugewiesen. Nach der Installation von <strong>Geoserver</strong> sind mehrere Beispiellayer, -datenspeicher und -arbeitsbereiche vorhanden. Diese können gelöscht werden.</p><h5 id="geoserverarbeitsbereich">5.2.1 Arbeitsbereich</h5><p>Es müssen zwei Arbeitsbereiche angelegt werden.</p><table><tr class="tableHeader"><td>Name </td><td>Namensraum-URI </td><td>Standardarbeitsbereich </td><td>Beispiel </td><td>Bemerkungen </td></tr><tr><td>klarschiff </td><td>http://domain/ows/klarschiff </td><td>ja </td><td>http://musterstadt.de/ows/klarschiff </td><td>Arbeitsbereich für den Standort </td></tr><tr><td>zufi </td><td>http://domain/ows/zufi </td><td>nein </td><td>http://musterstadt.de/ows/zufi </td><td>Arbeitsbereich Zuständigkeitsfinder </td></tr></table><h5 id="geoserverdatenspeicher">5.2.2 Datenspeicher</h5><p>Zu jedem angelegten Arbeitsbereich muss ein [Datenspeicher] angelegt werden.</p><ul><li>Datenquelle hinzufügen für Vektordaten -&gt; <em><ins>PostGIS</ins></em><ul><li>Informationen zum Datenspeicher:<ul><li><strong>Arbeitsbereich:</strong> <strong>klarschiff</strong></li><li>aktiv: ja</li></ul></li><li>Verbindungsparameter<ul><li>Name der Datenquelle: localhost_klarschiff_frontend</li><li>host: localhost</li><li>port: 5432</li><li>database: <a href="#datenbank">klarschiff_frontend</a></li><li>schema: klarschiff</li><li>user: <a href="#frontend">klarschiff_frontend</a></li><li>passwd: <a href="#frontend">klarschiff_frontend</a></li><li>Expose primary keys:ja</li><li>max connections: 30</li><li>min connections: 10</li><li>fetch size: 5000</li><li>Connection timeout: 60</li><li>validate connections: nein</li><li>Test while idle: ja</li><li>Evictor run periodicity: 300</li><li>Max connection idle time: 300</li><li>Evictor tests per run: 3</li><li>Max open prepared statements: 5</li></ul></li></ul></li></ul><ul><li>Datenquelle hinzufügen für Vektordaten -&gt; <em><ins>PostGIS</ins></em><ul><li>Informationen zum Datenspeicher:<ul><li><strong>Arbeitsbereich:</strong> <strong>zufi</strong></li><li>aktiv: ja</li></ul></li><li>Verbindungsparameter<ul><li>Name der Datenquelle: localhost_zufi</li><li>host: localhost</li><li>port: 5432</li><li>database: <a href="#zufi">zufi</a></li><li>schema: zufi</li><li>user: <a href="#zufi">zufi</a></li><li>passwd: <a href="#zufi">zufi</a></li><li>Expose primary keys:ja</li><li>max connections: 30</li><li>min connections: 10</li><li>fetch size: 5000</li><li>Connection timeout: 60</li><li>validate connections: nein</li><li>Test while idle: ja</li><li>Evictor run periodicity: 300</li><li>Max connection idle time: 300</li><li>Evictor tests per run: 3</li><li>Max open prepared statements: 5</li></ul></li></ul></li></ul><h5 id="geoserverlayer">5.2.3 Layer</h5><p>Zur Erstellung eines neuen Layers wird aus dem Datenspeicher eine Tabelle publiziert. Dabei gelten folgende Zuordnungen:</p><table><tr class="tableHeader"><td>Datenquelle </td><td>Name </td><td>Angegebenes Koordinatenreferenzsystem </td></tr><tr><td>localhost_klarschiff_frontend </td><td>stadtteile</td><td>EPSG:25833 </td></tr><tr><td>localhost_klarschiff_frontend </td><td>vorgaenge </td><td>EPSG:25833 </td></tr><tr><td>localhost_klarschiff_frontend </td><td>klarschiff_geo_rss </td><td>EPSG:25833 </td></tr></table><h3 id="a6Solr" class="solr">6 Solr</h3><p>Das <strong>Backend</strong> und das <strong>Frontend</strong> von <strong>Klarschiff</strong> verfügen über eine Funktion für die Adress- und Standortsuche. Hier wird die Programmbibliothek <strong>Apache Lucene</strong> der Apache Software Foundation zur Volltextsuche genutzt. <strong>Solr</strong> ist ein in Lucene enthaltenes Servlet für entsprechende Container wie dem Webserver <a href="#tomcat"><strong>Apache Tomcat</strong></a>.</p><p>Maßgebend für die Konfiguration ist die XML-Datei <em>solr.xml</em> Konfigurationsordner des Webservers <a href="#tomcat"><strong>Apache Tomcat</strong></a>.</p><pre><code>&lt;?xml version="1.0"?&gt;
-&lt;Context crossContext="true" debug="0" docBase="C:/share/solr/solr.war"&gt;
&lt;Environment override="true" value="/data/solr" type="java.lang.String" name="solr/home"/&gt;
&lt;/Context&gt;
</code></pre><p>Hier wird dem Webserver mitgeteilt, wo sich die WAR-Datei befindet und welches das Home-Verzeichnis von <strong>Solr</strong> ist.</p><h3 id="ruby">7. Ruby</h3><p>Zum Betreiben der Anwendung <strong>Klarschiff</strong> wird die Programmiersprache <strong>Ruby</strong> nicht benötigt. Sie ist für die Nutzung der Hilfsprogramme für den Datenimport und der Applikationen <strong>citysdk</strong>, <strong>field_service</strong> und <strong>klarschiff-xfall</strong> notwendig. Alle Erweiterungen sind mithilfe der Programmiersprache <strong>Ruby</strong> entwickelt worden. <strong>Ruby</strong>-Programme werden zur Laufzeit interpretiert.</p><p>Neben <strong>Ruby</strong> benötigt man für die Verbindung zu <strong>PostgreSQL</strong> noch das <strong>RubyGem</strong> <strong><em>PG</em></strong>. Lässt sich das <strong>RubyGem</strong> nicht einbinden, muss die Entwicklungsumgebung von <strong>Ruby</strong> installiert werden. Dieses ist abhängig vom verwendeten Betriebssystem.</p><p>Eine aktuelle Beschreibung der Installation von <strong>Ruby</strong> für die verschiedenen Betriebssysteme findet man unter <a href="https://www.ruby-lang.org/de/documentation/installation/">https://www.ruby-lang.org/de/documentation/installation/</a>.</p><h3 id="github">8. GitHub (Git)</h3><p><strong>GitHub</strong> ist ein webbasierter Filehosting-Dienst für Software-Entwicklungsprojekte. Zum Betrieb von <strong>Klarschiff</strong> wird <strong>GitHub</strong> aber nicht benötigt.</p><p><strong>Klarschiff</strong> wird ständig weiterentwickelt. Die jeweils aktuellste Version des <strong>Backends</strong> und des <strong>Frontends</strong> findet man unter den Adressen die in der folgenden Tabelle aufgeführt sind.</p><table><tr class="tableHeader"><td>Anwendung </td><td>URI </td></tr><tr><td>Frontend </td><td><a href="https://github.com/bfpi/klarschiff-frontend">https://github.com/bfpi/klarschiff-frontend</a> </td></tr><tr><td>Backend </td><td><a href="https://github.com/bfpi/klarschiff-backend">https://github.com/bfpi/klarschiff-backend</a> </td></tr></table><p>Mithilfe von <strong>GitHub</strong> kann mit wenigen Schritten die jeweils aktuellste Version ausgecheckt werden. </p><p>Es besteht auch die Möglichkeit, an den in der Tabelle aufgeführten Orten eine ZIP-Datei herunterzuladen. Nach dem Entpacken müssen dann die Dateien bzw. Verzeichnisse an die entsprechende Stelle kopiert werden.</p><p>Die aktuelle Version von <strong>GitHub Desktop</strong> für <strong>MS Windows</strong> findet man unter der Adresse <a href="https://windows.github.com/">https://windows.github.com/</a>. Auf linuxbasierten Betriebssystemen erfolgt die Installation mithilfe der entsprechenden Paketverwaltung. Es muss das Paket <strong>Git</strong> installiert werden.</p><h3 id="maven">9. Maven</h3><p><strong>Maven</strong> ist ein Build-Management-Tool der <strong>Apache Software Foundation</strong> und basiert auf <strong>Java</strong>. Mithilfe von <strong>Maven</strong> wird die Software für das <strong>Backend</strong> in eine WAR-Datei &#8222;gepackt&#8221;. Voraussetzung für die Nutzung von <strong>Maven</strong> ist eine aktuelles <a href="#java"><strong>Java SE Development Kit</strong></a> (JDK). Zur Nutzung von <strong>Maven</strong> muss die Umgebungsvariable <em>JAVA_HOME=Pfad/zum/jdk</em> gesetzt sein. Weiterhin muss der Pfad zu <strong>Maven</strong> in der PATH Variablen bekannt gegeben werden.</p><h3 id="nodejs">10. Nodejs</h3><p><strong>Node.js</strong> ist eine serverseitige Plattform zum Betrieb von Netzanwendungen. <strong>Node.js</strong> enthält einige Module und den Node Package Manager (npm).</p><p>Eine Installationsanleitung mithilfe eines Paketmanagers findet man unter <a href="https://github.com/joyent/node/wiki/Installing-Node.js-via-package-manager#debian-and-ubuntu-based-linux-distributions">https://github.com/joyent/node/wiki/Installing-Node.js-via-package-manager#debian-and-ubuntu-based-linux-distributions</a>.</p><p>Die Version für <strong>MS Windows</strong> findet man unter <a href="https://nodejs.org/">https://nodejs.org/</a>.</p><p>Nach der Installation muss gegebenenfalls ein Proxy angepasst werden.</p><pre><code>npm config set proxy http://meine-proxy-domain:mein-proxy-port
npm config set https-proxy http://meine-proxy-domain:mein-proxy-port
</code></pre><h3 id="openldap">11. OpenLDAP</h3><p>Für die Nutzung von <strong>Klarschiff</strong> ist eine LDAP &#8211; Umgebung notwendig. In ihr werden die Nutzer, die zuständigen Gruppen und die damit verbundenen Rechte verwaltet. Ist keine LDAP &#8211; Umgebung vorhanden kann mithilfe von <strong>OpenLDAP</strong> eine solche aufgebaut werden. <strong>OpenLDAP</strong> ist Bestandteil der meisten aktuellen <strong>Linux</strong> Distributionen und kann über die Paketverwaltung installiert werden. Es sind der OpenLDAP-Server (slapd) und die OpenLDAP-Hilfsprogramme (ldap-utils) zu installieren. Eine Version für <strong>MS Windows</strong> findet man unter <a href="http://www.userbooster.de/download/openldap-for-windows.aspx">http://www.userbooster.de/download/openldap-for-windows.aspx</a>.</p><p>Soll kein LDAP-Server eingerichtet werden, können mithilfe einer <acronym title="LDAP Data Interchange Format">LDIF</acronym> Datei Nutzer und zuständige Gruppen eingerichtet werden.</p><p>Beispiel <acronym title="LDAP Data Interchange Format">LDIF</acronym>-Datei:</p><pre><code>dn: dc=klarschiff,dc=local
objectClass: organization
objectClass: top

dn: ou=users,dc=klarschiff,dc=local
objectClass: organizationalUnit
objectClass: top
description: Nutzer

dn: ou=groups,dc=klarschiff,dc=local
objectClass: organizationalUnit
objectClass: top
description: Gruppen

# Administrator
dn: uid=admin,dc=klarschiff,dc=local
objectclass: person
objectclass: oganizationalperson
objectclass: inetorgperson
uid:admin
cn: Administrator
userPassword: admin

# Nutzer1
dn: uid=u1,ou=users,dc=klarschiff,dc=local
objectclass: person
objectclass: oganizationalperson
objectclass: inetorgperson
uid: u1
cn: u1
userPassword: u1

# Nutzer2
dn: uid=u2,ou=users,dc=klarschiff,dc=local
objectclass: person
objectclass: oganizationalperson
objectclass: inetorgperson
uid:u2
cn: u2
userPassword: u2

# Gruppe Bauamt
dn: cn=bauamt,ou=groups,dc=klarschiff,dc=local
objectclass: groupOfNames
objectclass: top
cn: a66_bauamt
description: Bauamt
o: intern
member: uid=u1,ou=users,dc=klarschiff,dc=local
l: Standort irgendwo


# AdminGruppe für Klarschiff
dn: cn=admin,ou=groups,dc=klarschiff,dc=local
objectClass: groupOfNames
objectClass: top
cn: admin
member: uid=u1,ou=users,dc=klarschiff,dc=local
description: Administratoren des Backend von Klarschiff
o: admin

</code></pre><h2 id="klarschiff_frontend">Klarschiff-Frontend</h2><p>Die Anwendung aus dem Git-Repository klonen.</p><pre><code>git clone https://github.com/bfpi/klarschiff-frontend /Pfad/zum/Anwendungsverzeichnis/des/Webservers/apache
</code></pre><p>oder als ZIP-Datei herunterladen und im Anwendungsverzeichnis des Webservers <a href="#apache"><strong>Apache</strong></a> entpacken.<br/>Das Anwendungsverzeichnis des Webservers <strong>Apache</strong> wird in der Konfigurationsdatei des Webservers unter der Variablen <em>DocumentRoot</em> festgelegt. Dieses kann auch in der Datei <em>klarschiff.conf</em> erfolgen.</p><p>Im Anwendungsverzeichnis des Webservers <strong>Apache</strong> einen symbolischen Link auf die Datei <a href="#startphp"><em>start.php</em></a> im Anwendungsverzeichnis des Frontends anlegen. In dieser Datei wird entschieden ob die mobile Variante oder die Desktop-Variante des Frontends aufgerufen wird.</p><p>Im Anwendungsverzeichnis des Frontends</p><pre><code>npm install
</code></pre><p>in der Konsole ausführen. Es wird der Javascript Task Runner <strong>Grunt</strong> mit den notwendigen Paketen installiert. Grundlage bildet die Datei <em>package.json</em>.</p><p>Ist das Anwendungsverzeichnis des Frontends nicht <em>http://localhost/frontend</em> muss dies in der Datei <em>Gruntfile.js</em> auf <em>http://localhost/webserverpfad/zum/anwendungsverzeichnis</em> angepasst werden.</p><p>Im Anschluss</p><pre><code>npm install -g grunt-cli
</code></pre><p>ausführen.</p><p>Zur Einrichtung der Datenbankverbindung die Datei <em>Anwendungsverzeichnis/config/database.sample.php</em> bearbeiten und kopieren als <em>Anwendungsverzeichnis/config/database.php</em>.</p><p>Installieren und einrichten der referenzierten Bibliotheken mithilfe von <strong>Grunt</strong>.</p><pre><code>grunt install
</code></pre><p>Für die Tasks sind zwei Umgebungen vorbereitet. In der Standardkonfiguration (development) werden die Javaskripte nur zusammengefasst. Es gibt eine Überwachungsfunktion die bei Änderungen an den Quelldateien automatisch neue Builds für die Referenz in der Seite erstellt. Mit dem Setzen einer Umgebungsvariablen <em>GRUNT_ENV=production</em> werden die Skripte für eine bessere Leistung zusätzlich komprimiert an den Browser ausgeliefert. Eine Überwachung ist nicht konfiguriert.</p><p>Für beide Umgebungen wir der Standard Task wie folgt aufgerufen:</p><pre><code>grunt
</code></pre><h3 id="konfigurationsdateienfontend">1. Konfigurationsdateien Frontend</h3><p>Die Konfigurationsdateien des <strong>Frontends</strong> befinden sich im Arbeitsverzeichnis und im Unterverzeichnis <em>Arbeitsverzeichnis/config</em>.</p><h4 id="startphp">1.1 start.php</h4><p>In Abhängigkeit vom verwendeten Endgerät oder Browser wird hier entschieden, ob die mobile Variante oder die Desktopvariante von <strong>Klarschiff</strong> aufgerufen wird.</p><h4 id="urlsphp">1.2 urls.php</h4><p>In dieser Datei wird unter anderem eingetragen, unter welcher URL die Anwendungen wie</p><ul><li><strong>Backend</strong></li><li><strong>Frontend</strong></li><li>mobile Variante vom <strong>Frontend</strong></li></ul><p>zu finden sind.</p><h4 id="configjsphp">1.3 config.js.php</h4><p>Hier werden </p><ul><li>das Zentrum</li><li>die Größe und </li><li>die Zoomstufen</li></ul><p>der Karte des <strong>Frontends</strong> festgelegt.</p><p>Weiterhin wird hier entschieden, welcher Meldungstyp <em>Idee</em> oder <em>Problem</em> oder beide möglich sind. Es werden die Platzhalter für das Meldungsformular und die möglichen Fehlermeldungen definiert.</p><p>Es erfolgt die Definition der Layer für das <strong>Frontend</strong>:</p><ul><li>den Stadtplan,</li><li>das Luftbild,</li><li>der <acronym title="Points of Interest">POI</acronym> und</li><li>der Meldungen.</li></ul><h4 id="mapphp">1.4 map.php</h4><p>In dieser Datei erfolgt der Aufbau und die Steuerung des Menüs in der Kartendarstellung.</p><h2 id="klarschifffrontendmobil">Klarschiff Frontend mobil</h2><p>Das mobile Frontend für <strong>Klarschiff</strong> ist eine angepasste Version des Frontends für mobile Endgeräte wie PDA, Handhelds, Smartphones usw. Beim Ausführen der <em>start.php</em> wird versucht mithilfe der Browserkennungen mobile Endgeräte zu erkennen. Wird ein solcher Browser erkannt, wird das mobile <strong>Frontend</strong> verwendet. Die angewendete Methode ist nicht immer zuverlässig, weil die Browserkennung vom Nutzer verändert oder unterdrückt und die Liste aller Kennungen nur schwerlich aktuell gehalten werden kann.</p><p>Ein funktionsfähiges Build vom <strong>Klarschiff Frontend mobil</strong> sollte mithilfe eines <strong>Linux</strong>-Systems erzeugt werden. Bis zum Redaktionszeitpunkt war die Erzeugung mithilfe eines <strong>MS Windows</strong> nicht gelungen.</p><p>Die Anwendung aus dem Git-Repository klonen.</p><pre><code>git clone https://github.com/bfpi/klarschiff-mobil /Pfad/zu/einem/Arbeitsverzeichnis
</code></pre><p>oder als ZIP-Datei herunterladen und in einem Arbeitsverzeichnis entpacken.</p><p>In diesem Arbeitsverzeichnis <a href="https://github.com/mwaylabs/Espresso"><strong>Espresso</strong></a> mithilfe von npm und der Datei <em>package.json</em> installieren.</p><pre><code>npm install
alias espresso=`pwd`/node_modules/espresso/bin/espresso.js
</code></pre><p>Um ein neues Build aus den aktuellen Anwendungsquellen zu erzeugen, wird im Verzeichnis <em>Arbeitsverzeichnis/KsMobil</em> das Espresso-Build-Tool genutzt:</p><pre><code>espresso build
</code></pre><p>Das fertige Build wird automatisch im Verzeichnis <em>Arbeitsverzeichnis/KsMobil/build/{version}</em> abgelegt. Der Inhalt dieses Verzeichnis muss dann in das Verzeichnis für das mobile <strong>Frontend</strong> des Webserver <a href="#apache"><strong>Apache</strong></a> kopiert oder verschoben werden.</p><p>Vor der Erstellung des Builds ist darauf zu achten, dass die entsprechenden Kartendaten, wie Mittelpunkt und die Größe der Karte, in der Datei <em>Arbeitsverzeichnis/KsMobil/app/controllers/MapController.js</em> eingetragen werden.</p><p>Das Verzeichnis für das mobile Frontend in der Datei <a href="#urlsphp"><em>urls.php</em></a> im <em>Anwendungsverzeichnis/frontend/config</em> anpassen.</p><h2 id="klarschiff_backend">Klarschiff-Backend</h2><p>Die Anwendung aus dem Git-Repository klonen</p><pre><code>git clone https://github.com/bfpi/klarschiff-backend /Pfad/zu/einem/Arbeitsverzeichnis
</code></pre><p>oder als ZIP-Datei herunterladen und in ein Arbeitsverzeichnis entpacken. Im Anschluss muss die Datei <a href="#settingproperties"><em>settings.sample.properties</em></a> im Verzeichnis <em>Arbeitsverzeichnis/src/main/resources</em> angepasst und in die Datei <em>settings.properties</em> kopiert oder umbenannt werden.</p><p>Durch das Ausführen von <a href="#maven"><strong>Maven</strong></a></p><pre><code>mvn clean
mvn package
</code></pre><p>im Arbeitsverzeichnis wird im Verzeichnis <em>Arbeitsverzeichnis/target</em> eine <em>backend-x.y.war</em> Datei erstellt. Die so erzeugte Datei muss dann in <em>backend.war</em> umbenannt werden.</p><p>Die <em>WAR</em>-Datei in das entsprechende Verzeichnis des Webservers <a href="#tomcat"><strong>Tomcat</strong></a> kopieren. Dieses ist, falls nicht anders konfiguriert, das Verzeichnis <em>../webapps</em>. Der Webserver installiert dann das <strong>Backend</strong> automatisch.</p><p>Beim ersten Aufruf des <strong>Backends</strong> im Browser werden die Tabellen in der Datenbank <em>klarschiff_backend</em> initialisiert. Ist die Datei <a href="#settingproperties"><em>settings.properties</em></a> richtig konfiguriert werden auch die Tabellen der Datenbank <em>klarschiff_frontend</em> erzeugt. Dieses kann mithilfe von <strong>pgAdmin III</strong> kontrolliert werden. Wurden keine Tabellen angelegt ist die Datei <a href="#settingproperties"><em>settings.properties</em></a> nicht richtig konfiguriert. Die Tabellen kann ein Administrator des <strong>Backends</strong> im Bereich Administration auf der Registerkarte <em>Datenbank</em> mithilfe eines Skripts anlegen. An dieser Stelle erfolgt auch die Bereitstellung der Trigger und Triggerfunktionen für die automatische Synchronisation der Daten aus der <strong>Backend</strong>- in die <strong>Frontend</strong>-Datenbank.</p><h3 id="settingproperties">1. Setting.properties</h3><p>Der zentrale Punkt für die Einstellungen für das <strong>Backend</strong> ist die Datei <em>settings.properties</em>. Hier werden alle Parameter für den Lauf der Anwendung angepasst.</p><p>Im Verzeichnis <em>Arbeitsverzeichnis/backend/src/main/resources</em> befindet sich eine Datei <em>settings.sample.properties</em>. Diese Datei stellt ein Beispiel für Datei <em>settings.properties</em> dar. Wird die Datei <em>settings.sample.properties</em> als Vorlage genutzt, muss diese nach der Bearbeitung unter dem Namen <em>settings.properties</em> gespeichert werden. Die Bearbeitung sollte vor dem Erzeugen der WAR-Datei für das <strong>Backend</strong> durchgeführt werden. Es besteht auch die Möglichkeit die Datei <em>settings.properties</em> im Verzeichnis <em>../backend/WEB-INF/classes</em> zu bearbeiten. Dabei zu beachten, dass bei einer Aktualisierung des <strong>Backends</strong> mithilfe einer WAR-Datei die so aktualisierte Datei überschrieben wird und damit die Änderungen verloren gehen.</p><h4 id="kontextderanwendung">1.1 Kontext der Anwendung</h4><table><tr><td><code>context.app.title</code> </td><td>Titel der Anwendung z. B. Klarschiff </td></tr><tr><td><code>context.app.area</code> </td><td>Geografisches Gebiet z.B. Stadt </td></tr><tr><td><code>context.app.demo</code> </td><td>Kennzeichnung als Demo-Version (<code>true</code>, <code>false</code>) </td></tr></table><h4 id="serverurlsfueremails">1.2 Server URLs für E-Mails</h4><table><tr><td><code>mail.server.baseurl.backend</code> und <code>mail.server.baseurl.frontend</code> </td><td>Die URLs werden bei der Erzeugung von E-Mails an den Verfasser einer Meldung verwendet und sollten auf die entsprechenden URLs des Frontend und Backend verweisen. </td></tr></table><h4 id="mailversand">1.3 Mailversand</h4><table><tr><td><code>mail.host</code> </td><td>IP-Adresse oder Hostname des SMTP-Host, der für den Versand der E-Mails verwendet wird </td></tr><tr><td><code>mail.smtp.starttls.enable</code> </td><td>aktiviert (<code>true</code>) oder deaktiviert (<code>false</code>) die Verschlüsselung mit dem SMTP-Host; Eine Aktivierung wird z.B. bei der Verwendung eines Google-Mail-Accounts benötigt. </td></tr><tr><td><code>mail.username</code> und <code>mail.password</code> </td><td>Benutzername und Passwort für den SMTP-Zugang, wenn dieser benötigt wird </td></tr><tr><td><code>mail.from</code> </td><td>Absenderadresse für die vom System versendeten E-Mails </td></tr><tr><td><code>mail.sendAllMailsTo</code> </td><td>Wenn hier eine E-Mail-Adresse angegeben wird, werden alle E-Mails an diese Adresse versendet. Dieses ist beispielsweise zum Test der E-Mail-Funktionen sinnvoll. </td></tr></table><h4 id="encodingfueremailmailto">1.4 Encoding für E-Mail-"mailto"</h4><table><tr><td><code>mail.mailto.encoding</code> </td><td>z. B. UTF-8 </td></tr></table><h4 id="einstellungendatenbankbackend">1.5 Einstellungen Backend-Datenbank</h4><table><tr><td><code>database.host</code> </td><td>IP-Adresse oder Hostname </td></tr><tr><td><code>database.port</code> </td><td>Port </td></tr><tr><td><code>database.schema</code> </td><td>Schema </td></tr><tr><td><code>database.dbname</code> </td><td>Name der Backend-Datenbank</td></tr><tr><td><code>database.username</code> </td><td>Benutzername für Backend-Datenbank </td></tr><tr><td><code>database.password</code> </td><td>Password für Benutzer Backend-Datenbank </td></tr></table><h4 id="einstellungendatenbankfrontend">1.6 Einstellungen Frontend-Datenbank</h4><p>Die folgenden Angaben werden für die Erstellung der <strong>Frontend</strong>-Datenbank benötigt.</p><table><tr><td><code>database.frontend.host</code> </td><td>IP-Adresse Host oder Hostname </td></tr><tr><td><code>database.frontend.port</code> </td><td>Port </td></tr><tr><td><code>database.frontend.schema</code> </td><td>Schema </td></tr><tr><td><code>database.frontend.dbname</code> </td><td>Name der Frontend-Datenbank </td></tr><tr><td><code>database.frontend.username</code> </td><td>Benutzername für Frontend-Datenbank</td></tr><tr><td><code>database.frontend.password</code> </td><td>Password Benutzer Frontend-Datenbank </td></tr></table><h4 id="datenbankskriptefuerdblinkundfrontenddatenbank">1.7 Datenbankskripte für dblink und Frontend-Datenbank</h4><table><tr><td><code>init.sqlscript.frontenddb</code> </td><td>Hier wird festgelegt, ob das SQL-Skript zum Erzeugen der FrontendDb ausgeführt wird. Das Skript wird nur ausgeführt, wenn noch keine Daten in der Backend-Datenbank vorhanden sind. Die Ausführung erfolgt nach dem Erzeugen der Tabellen in der Backend-Datenbank. Folgende Werte sind möglich: <code>disabled</code> - Skript wird nicht ausgeführt, <code>warn</code> - Skript wird ausgeführt und es gibt im Log eine Fehlermeldung bei einem Fehler, <code>error</code> - Skript wird ausgeführt und der Start des Backends wird im Fehlerfall abgebrochen </td></tr><tr><td><code>init.sqlscript.dblink</code> </td><td>Hier wird festgelegt, ob das SQL-Skript, welches für die Synchronisation der Frontend- und Backend-Datenbank auf der Basis von <em>dbLink</em> verantwortlich ist, ausgeführt wird. Das Skript wird nur ausgeführt, wenn noch keine Daten in der Backend-Datenbank vorhanden sind. Die Ausführung erfolgt nach dem Erzeugen der Tabellen in der Backend-Datenbank. Folgende Werte sind möglich: <code>disabled</code> - Skript wird nicht ausgeführt, <code>warn</code> - Skript wird ausgeführt und es gibt im Log eine Fehlermeldung bei einem Fehler, <code>error</code> - Skript wird ausgeführt und der Start des Backends wird im Fehlerfall abgebrochen </td></tr></table><h4 id="dateisystempfadundurlzudenfotos">1.8 Dateisystempfad und URL zu den Fotos</h4><table><tr><td><code>image.path</code> </td><td>Ablageverzeichnis der Fotos </td></tr><tr><td><code>image.url</code> </td><td>URL der Fotos </td></tr></table><h4 id="automatischejobs">1.9 Automatische Jobs</h4><table><tr><td><code>job.monthsToArchivVorgaenge</code> </td><td>Alter abgeschlossener Vorgänge in Monaten, bis diese automatisch archiviert werden. </td></tr><tr><td><code>job.hoursToRemoveUnbestaetigtVorgang</code> </td><td>Alter von unbestätigten Vorgängen in Stunden, bis diese automatisch gelöscht werden. </td></tr><tr><td><code>job.hoursToRemoveUnbestaetigtUnterstuetzer</code> </td><td>Alter von unbestätigten Unterstützungen in Stunden, bis diese automatisch gelöscht werden. </td></tr><tr><td><code>job.hoursToRemoveUnbestaetigtMissbrauchsmeldung</code> </td><td>Alter von unbestätigten Missbrauchsmeldungen in Stunden, bis diese automatisch gelöscht werden. </td></tr></table><h4 id="tmsfuerkarte">1.10 <acronym title="Tile Map Service">TMS</acronym> für Karte</h4><h5 id="kartendarstellungmitopenlayers">1.10.1 Kartendarstellung mit OpenLayers</h5><table><tr><td><code>geo.map.projection</code> </td><td>Verwendete Projektion im System </td></tr><tr><td><code>geo.map.maxExtent</code> </td><td>Begrenzen der Daten der Karte </td></tr><tr><td><code>geo.map.restrictedExtent</code> </td><td>Maximal anzuzeigende Größe der Karte </td></tr><tr><td><code>geo.map.resolutions</code> </td><td>Verwendbare Zoomstufen </td></tr><tr><td><code>geo.map.serverResolutions</code> </td><td>Vom Server bereitgestellte Zoomstufen </td></tr><tr><td><code>geo.map.ovi.margin</code> </td><td>Darzustellender Umkreis bei der Anzeige eines Ortes </td></tr><tr><td><code>geo.map.tms.server</code> </td><td><acronym title="Tile Map Service">TMS</acronym>-Server für die Darstellung der Karten im Backend </td></tr><tr><td><code>geo.map.tms.server.layers</code> </td><td>Layer des <acronym title="Tile Map Service">TMS</acronym>, die bei der Kartendarstellung verwendet werden sollen. Format: <code lang="LayerNameInDerAnzeige1">:[LayernameBeimTms1],[LayerNameInDerAnzeige2]:[LayernameBeimTms2],...</code> </td></tr></table><h5 id="darstellungeinesvorgangsbzwdesortesineinemexternensystem">1.10.2 Darstellung eines Vorgangs bzw. des Ortes in einem externen System</h5><table><tr><td><code>geo.map.extern.projection</code> </td><td>Projektion im externen System </td></tr><tr><td><code>geo.map.extern.url</code> </td><td>URL zur Darstellung eines Ortes und mit der VorgangsID in einem externen System (es können die Variablen <code>%x%</code>, <code>%y%</code> und <code>%id%</code> verwendet werden) </td></tr><tr><td><code>geo.map.extern.extern.url</code> </td><td>URL zur Darstellung eines Vorgangs im <strong>Frontend</strong> </td></tr></table><h5 id="wmsmitzusaetzlichenpoifuerkarte">1.10.3 <acronym title="Web Map Service">WMS</acronym> mitzusätzlichen <acronym title="Points of Interest">POI</acronym> für Karte</h5><table><tr><td><code>geo.wms.url</code> </td><td>URL des <acronym title="Web Map Service-Servers">WMS</acronym> </td></tr><tr><td><code>geo.wms.title</code> </td><td>Titelbezeichnung </td></tr><tr><td><code>geo.wms.layers</code> </td><td>Bezeichnung der Layer auf dem <acronym title="Web Map Service">WMS</acronym>-Server (Komma getrennt) </td></tr><tr><td><code>geo.wms.image</code> </td><td>Format des ausgelieferten Layers </td></tr><tr><td><code>geo.wms.tranparent</code> </td><td>Transparenz des Layers <code>true</code> - ja <code>false</code> - nein </td></tr><tr><td><code>geo.wms.minScale</code> </td><td>Größe des Layers </td></tr><tr><td><code>geo.wms.singleTile</code> </td><td>Der Layer wird als ein Bild geliefert (<code>true</code>). Layer wird aus &#8222;Kacheln&#8221; zusammengesetzt. (<code>false</code>) </td></tr></table><h5 id="wfsmitvorgaengenfuerkarte">1.10.4 <acronym title="Web Feature Service">WFS</acronym> mit Vorgängen für Karte</h5><table><tr><td><code>geo.wfsvorgaenge.url</code> </td><td>URL des <acronym title="Web Feature Service">WFS</acronym>-Servers </td></tr><tr><td><code>geo.wfsvorgaenge.featurens</code> </td><td>Namensraum </td></tr><tr><td><code>geo.wfsvorgaenge.featureprefix</code> </td><td>Arbeitsbereich </td></tr><tr><td><code>geo.wfsvorgaenge.featuretype</code> </td><td>Typ des Vorganges </td></tr></table><h5 id="wfsfuerzustaendigkeitsfinder">1.10.5 <acronym title="Web Feature Service">WFS</acronym> für Zuständigkeitsfinder</h5><table><tr><td><code>geo.wfszufi.exception.handling</code> </td><td>Fehlerbehandlung beim Initialisieren des <acronym title="Web Feature Service">WFS</acronym> (<code>warn</code> - Fehlermeldungen werden in das Log geschrieben, <code>error</code> - der Start der Webanwendung wird bei einem Fehler abgebrochen) </td></tr><tr><td><code>geo.wfszufi.ovi.buffer</code> </td><td>Umkreis in Metern, der bei der Berechnung der Features für den Zuständigkeitsfinder berücksichtigt werden soll </td></tr><tr><td><code>geo.wfszufi.capabilities.url</code> </td><td>Abfrage der verfügbaren Methoden des <acronym title="Web Feature Service">WFS</acronym>-Servers (... request=GetCapabilities) </td></tr><tr><td><code>geo.wfszufi.featureprefix</code> </td><td>Arbeitsbereich des Zuständigkeitsfinders </td></tr><tr><td><code>geo.wfszufi.bewirtschaftungskataster.featuretype</code> </td><td>Typ des Vorgangs z.B. <em>bewirtschaftung</em> </td></tr><tr><td><code>geo.wfszufi.bewirtschaftungskataster.propertyname</code> </td><td>Feldname des Bewirtschafters </td></tr><tr><td><code>geo.wfszufi.bewirtschaftungskataster.geomname</code> </td><td>Feldname der Geometriespalte </td></tr><tr><td><code>geo.wfszufi.flaechendaten.geomname</code> </td><td>Feldname der restlichen Flächen </td></tr></table><h4 id="adressensuche">1.11 Adressensuche</h4><table><tr><td><code>geo.adressensuche.url</code> </td><td>Adressensuche im Backend möglich (<code>true</code>) </td></tr></table><h4 id="proxy">1.12 Proxy</h4><table><tr><td><code>proxy.host</code> und <code>proxy.port</code> </td><td>Proxyeinstellungen, die der Server zur Kommunikation mit dem Internet benötigt. Diese werden z.B. für die Kommunikation mit dem <acronym title="Web Feature Service">WFS</acronym> benötigt </td></tr></table><h4 id="ldap">1.13 <acronym title="Lightweight Directory Access Protocol">LDAP</acronym></h4><p>Es kann ein <a href="#openldap"><acronym title="Lightweight Directory Access Protocol">LDAP</acronym>-Server</a> verwendet werden oder auf der Basis einer <acronym title="LDAP Data Interchange Format">LDIF</acronym>-Datei lokal ein <acronym title="Lightweight Directory Access Protocol">LDAP</acronym> mitgestartet werden, das dann verwendet wird. Hierzu ist jeweils der eine Parameter <code>ldap.server.ldif</code> oder <code>ldap.server.url</code> zu setzen und der andere frei zu lassen.</p><table><tr><td><code>ldap.server.ldif</code> </td><td>Wenn der Wert gesetzt ist, wird ein lokales <acronym title="Lightweight Directory Access Protocol">LDAP</acronym> gestartet und die Daten aus der hier angegebenen <acronym title="LDAP Data Interchange Format">LDIF</acronym>-Datei werden verwendet. </td></tr><tr><td><code>ldap.server.url</code> </td><td>URL eines <acronym title="Lightweight Directory Access Protocol">LDAP</acronym>-Servers </td></tr><tr><td><code>ldap.root</code> </td><td>Rootpfad für die Anfragen an den <acronym title="Lightweight Directory Access Protocol">LDAP</acronym> </td></tr><tr><td><code>ldap.managerDn</code> und <code>ldap.managerPassword</code> </td><td>Zugangsdaten für den <acronym title="Lightweight Directory Access Protocol">LDAP</acronym>-Server </td></tr><tr><td><code>ldap.userSearchBase</code> </td><td>Pfad, in dem nach Nutzern gesucht werden soll </td></tr><tr><td><code>ldap.userObjectClass</code> </td><td>Objektklasse für Nutzer </td></tr><tr><td><code>ldap.userSearchFilter</code> </td><td>Filter zum Suchen von Nutzern </td></tr><tr><td><code>ldap.userEmailFilter</code> </td><td>Filter für die Suche der E-Mail-Adresse des Nutzers </td></tr><tr><td><code>ldap.groupSearchBase</code> </td><td>Pfad, in dem nach Gruppen gesucht werden soll </td></tr><tr><td><code>ldap.groupObjectClass</code> </td><td>Objektklasse für Gruppen </td></tr><tr><td><code>ldap.groupRoleAttribute</code> </td><td>Attribut, in dem bei den Gruppen die Rolle <em>intern</em> oder <em>extern</em> gesetzt ist</td></tr><tr><td><code>ldap.groupSearchFilter</code> </td><td>Filter, in denen bei den Gruppen nach Benutzern gesucht wird </td></tr><tr><td><code>ldap.groupObjectId</code> </td><td>Attribut mit der ID für die Gruppe </td></tr><tr><td><code>ldap.userAttributesMapping</code> </td><td>Mapping für das Auslesen der Daten eines Benutzers beim <acronym title="Lightweight Directory Access Protocol">LDAP</acronym>. Format: <code lang="AttributNameAnwendung1">=[AttributNameLdap1],[AttributNameAnwendung2]=[AttributNameLdap2],...</code> </td></tr><tr><td><code>ldap.roleAttributesMapping</code> </td><td>Mapping für das Auslesen der Daten einer Gruppe beim <acronym title="Lightweight Directory Access Protocol">LDAP</acronym>. Format: <code lang="AttributNameAnwendung1">=[AttributNameLdap1],[AttributNameAnwendung2]=[AttributNameLdap2],...</code> </td></tr></table><p>Die folgende Abbildung stellt zur näheren Erläuterung dar, wie Benutzer und Gruppen im <acronym title="Lightweight Directory Access Protocol">LDAP</acronym> abzubilden sind und wie die Einstellungen in der <code>settings.properties</code> hierzu in Beziehung stehen.</p><p><img style="width:95%;padding:10px;background-color:#ffffff" border="0" src="img_LDAP_Klarschiff.jpg"/></p><p class="imgtext"><em>Abbildung:</em> Abbildung von Benutzern im <acronym title="Lightweight Directory Access Protocol">LDAP</acronym></p><p>Benutzer benötigen eine <code>uid</code> und ein <code>userPassword</code>, welche für das Login verwendet werden. Der Name (<code>cn</code>) und die Mailadresse (<code>mail</code>) werden im Backend für die Anzeige von Verlaufsdaten und für den Mailversand verwendet.</p><p>Bei den Gruppen wird zwischen <code>intern</code>, <code>extern</code>, <code>koordinator</code>, <code>aussendienst</code>, <code>dispatcher</code> und <code>admin</code> unterschieden. Die Gruppen <code>dispatcher</code> und <code>admin</code> existieren im LDAP nur jeweils einmal. Die Gruppen für <code>intern</code> und <code>extern</code> existieren i.d.R. mehrfach. Die Namen der Gruppen (<code>cn</code>) und die Beschreibung (<code>ou</code>) werden bei der Anzeige der Zuständigkeit bzw. beim Delegieren verwendet. </p><p>Die Verknüpfung der Gruppen mit Benutzern erfolgt über das Attribut <code>member</code> bei der Gruppe. Einer Gruppe können dabei mehrere Benutzer zugeordnet sein und auch ein Benutzer kann mehreren Gruppen angehören.</p><h4 id="a1.14Loginseite">1.14 Loginseite</h4><table><tr><td><code>show.logins</code> </td><td>Aktiviert (<code>true</code>) oder deaktiviert (<code>false</code>) eine Anzeige von statischen Logindaten unter dem Login </td></tr></table><h4 id="a1.15AnzahlUntersttzerbeiIdeen">1.15 Anzahl Unterstützer bei Ideen</h4><table><tr><td><code>vorgang.idee.unterstuetzer</code> </td><td>Anzahl der Unterstützungen, die eine Idee benötigt, damit sie in der einfachen Suche angezeigt wird </td></tr></table><h4 id="a1.16Fehlermeldungen">1.16 Fehlermeldungen</h4><table><tr><td><code>show.fehler.details</code> </td><td>Aktiviert (<code>true</code>) oder deaktiviert (<code>false</code>) die ausführliche Fehleranzeige in der Webanwendung </td></tr><tr><td><code>bug.tracking.url</code> </td><td>URL auf ein Bugtracking-System, die bei einem Fehler angezeigt wird </td></tr></table><h4 id="a1.17Connector">1.17 Connector</h4><table><tr><td><code>show.connector</code> </td><td>Aktiviert (<code>true</code>) oder deaktiviert (<code>false</code>) eine Anzeige des Connectors auf jeder Seite im Footer </td></tr></table><h4 id="a1.18Version">1.18 Version</h4><table><tr><td><code>version</code> </td><td>Bezeichnung der Version, die im Footer angezeigt werden soll </td></tr></table><p>Systemspezifischere Anpassungen, die z.B. bei der Weiterentwicklung vorgenommen werden müssen, können im ApplicationContext (<code>src_main\META-INF\spring\..xml</code>), dem WebApplicationContext (<code>WebContent\WEB-INF\spring\webmvc-config.xml</code>) oder an anderen Stellen vorgenommen werden.<br/>h2(#cluster). Webanwendung in einem Cluster</p><p>Das <strong>Backend</strong> von <strong>Klarschiff</strong> ist für den Lauf in einem Cluster vorbereitet. Hierzu wurden die folgenden Vorbereitungen getroffen:</p><ul><li>Die Sessionattribute implementieren das Interface <code>java.io.Serializable</code>, damit die Sessions zwischen den einzelnen Clients im Cluster synchronisiert werden können.</li><li>Die Hintergrundjobs werden mit Hilfe der DB synchronisiert, damit beispielsweise Mails nicht mehrfach versendet werden.</li><li>In der <code>web.xml</code> ist der Tag <code>&lt;distributable/&gt;</code> aktiviert.</li></ul><p>Damit das Backend in einem Cluster laufen kann, müssen die folgenden Schritte vorgenommen werden:</p><ul><li>Laufen auf einem Rechner mehrere Clients, so sind beim <strong>Apache Tomcat</strong>:#tomcat entsprechend die Ports anzupassen, damit es nicht zu Konflikten kommt.</li><li>In der <code>server.xml</code> des einzelnen <strong>Apache Tomcat</strong>:#tomcat muss eine ID für den Client (<code>jvmRoute="worker1"</code>) vergeben werden und der Lauf in einem Cluster muss aktiviert werden (<code>&lt;Cluster .../&gt;</code>).</li></ul><pre><code>	&lt;Engine defaultHost="localhost" name="Catalina" jvmRoute="worker1"&gt;
		&lt;Cluster className="org.apache.catalina.ha.tcp.SimpleTcpCluster"/&gt;
	...
	&lt;/Engine&gt;
</code></pre><p></p><ul><li>Ein Loadbalancer für die Verteilung der Anfragen auf die einzelnen Clients muss eingerichtet werden. Hierzu kann beispielsweise ein <strong>Apache</strong> oder <strong>Pound</strong> verwendet werden.</li></ul><p><strong>Loadbalancing mit einem Apache</strong></p><p>Nähere Information zum Einrichten eines Tomcat in einem Cluster mit einem <strong>Apache</strong> ist beispielsweise unter <a href="http://www.easywayserver.com/implementation-tomcat-clustering.htm">http://www.easywayserver.com/implementation-tomcat-clustering.htm</a> zu finden.</p><p><strong>Loadbalancing mit Pound</strong></p><p>Damit das Clustering mit <strong>Pound</strong> funktioniert, darf das Attribut <code>jvmRoute</code> in der <code>server.xml</code> der einzelnen Tomcats nicht gesetzt sein. Nähere Informationen zum Verwenden und Einrichten von <strong>Pound</strong> als Loadbalancer sind unter <a href="http://www.apsis.ch/pound/">http://www.apsis.ch/pound/</a> zu finden.</p><h2 id="import">Import</h2><p>Für die Initialisierung von <strong>Klarschiff</strong> stehen die folgenden Hilfsmittel zur Verfügung:</p><ul><li>Tool zum Importieren der <a href="#stadtteile">Stadteile</a></li><li>Tool zum Erstellen der Geo-Koordinaten aus einer <a href="#adressen">Adressdatei</a></li><li>Tool zum Importieren der <a href="#kategorien">Kategorien</a></li><li>Tool zum Importieren der <acronym title="Web Feature Service">WFS</acronym> <a href="#wfs">Vektordaten</a></li><li>Tool zum Importieren der Vektordaten für die Amtsflächen des <a href="#bewirtschafter">Zuständigkeitsfinders</a></li></ul><p>Diese Werkzeuge können <a href="https://github.com/bfpi/klarschiff-tools">https://github.com/bfpi/klarschiff-tools</a> aus dem <strong>GitHub</strong> heruntergeladen werden. Voraussetzung für die Nutzung der Werkzeuge ist ein installiertes <a href="#ruby"><strong>Ruby</strong></a>.</p><h3 id="stadtteile">1. Stadtteile</h3><p>Beim Import der Stadtteile werden in der Datenbank <em>standortsuche</em> die Tabelle <em>ortsteil und in der Datenbank _klarschiff_backend</em> die Tabelle <em>klarschiff_stadtteil_grenze</em> mit Daten gefüllt. Die Daten dafür werden aus der als Parameter übergebenen Shape-Datei entnommen.</p><pre><code>ruby import-stadteile.rb shape-datei
</code></pre><p>Die entsprechende Tabelle in der Datenbank <em>klarschiff_frontend</em> erhält ihre Daten aus der Datenbank <em>klarschiff_backend</em>.</p><h3 id="adressen">2. Adressen</h3><p>Die Grundlage bildet eine ASCII-Datei mit den amtlichen Hauskoordinaten Deutschland (HK-DE). Die HK-DE definiert die genaue räumliche Position von adressierten Gebäuden. Der Inhalt dieser Datei wird an die Datenbank <em>standortsuche</em> übergeben. Dabei wird die Datenbank mit den Orten, Straßen und Adressen gefüllt. Voraussetzung ist, dass die Stadtteile in der Datenbank <em>klarschiff_backend</em> vorhanden sind.</p><pre><code>ruby import-adressen.rb adressdatei
</code></pre><p>Nach dem Import der Adressen muss zur Indexierung der Adressen das PHP-Skript <code>updateIndex.php</code> ausgeführt werden. Damit steht in den einzelnen Programmteilen die Suche nach Adressen zur Verfügung.</p><h3 id="kategorien">3. Kategorien</h3><p>Zur Beschreibung eines Problems oder einer Idee ist eine Zuordnung zu einer Haupt- und Unterkategorie notwendig. Anhand dieser Kategorien wird eine erste Zuständigkeit ermittelt. Die Kategorien und Zuständigkeiten können mithilfe dieses Tools und einer CSV-Datei an das System übergeben werden.</p><pre><code>ruby import-kategorien.rb CSV-Datei
</code></pre><p>Aufbau der CSV-Datei:<br/>In der ersten Zeile steht eine Spaltenüberschrift. Diese Zeile wird nicht importiert.</p><table><tr class="tableHeader"><td>Kategorie </td><td>Art </td><td>Zuständigkeit </td><td>Anliegen-ID </td></tr><tr><td>Kategorie 1 </td><td>Problem </td><td> </td><td> </td></tr><tr><td>Unterkategorie 1 </td><td> </td><td>Abteilung 1 </td><td> </td></tr><tr><td>Unterkategorie 2 </td><td> </td><td>Abteilung 2 </td><td> </td></tr><tr><td style="text-align:center">* </td><td> </td><td style="text-align:center">* </td><td> </td></tr><tr><td style="text-align:center">* </td><td> </td><td style="text-align:center">* </td><td> </td></tr><tr><td style="text-align:center">* </td><td> </td><td style="text-align:center">* </td><td> </td></tr><tr><td>Unterkategorie n </td><td> </td><td>Abteilung m </td><td> </td></tr><tr><td>Kategorie 2 </td><td>Problem </td><td> </td><td> </td></tr><tr><td>Unterkategorie 1 </td><td> </td><td>Abteilung 1 </td><td> </td></tr><tr><td>Unterkategorie 2 </td><td> </td><td>Abteilung 2 </td><td> </td></tr><tr><td>Unterkategorie n </td><td> </td><td>Abteilung m </td><td> </td></tr><tr><td style="text-align:center">* </td><td> </td><td style="text-align:center">* </td><td> </td></tr><tr><td style="text-align:center">* </td><td> </td><td style="text-align:center">* </td><td> </td></tr><tr><td style="text-align:center">* </td><td> </td><td style="text-align:center">* </td><td> </td></tr><tr><td>Kategorie 2 </td><td>Idee </td><td> </td><td> </td></tr><tr><td>Unterkategorie 1 </td><td> </td><td>Abteilung 1 </td><td> </td></tr><tr><td>Unterkategorie 2 </td><td> </td><td>Abteilung 2 </td><td> </td></tr><tr><td style="text-align:center">* </td><td> </td><td style="text-align:center">* </td><td> </td></tr><tr><td style="text-align:center">* </td><td> </td><td style="text-align:center">* </td><td> </td></tr><tr><td style="text-align:center">* </td><td> </td><td style="text-align:center">* </td><td> </td></tr><tr><td>Unterkategorie n </td><td> </td><td>Abteilung m </td><td> </td></tr><tr><td style="text-align:center">* </td><td style="text-align:center">* </td><td style="text-align:center">* </td><td> </td></tr><tr><td style="text-align:center">* </td><td style="text-align:center">* </td><td style="text-align:center">* </td><td> </td></tr><tr><td style="text-align:center">* </td><td style="text-align:center">* </td><td style="text-align:center">* </td><td> </td></tr></table><h3 id="wfs">4. <acronym title="Web Feature Service">WFS</acronym></h3><p>Mithilfe dieses Skripts werden die Bereichsgrenzen von <strong>Klarschiff</strong> in die Tabelle <em>klarschiff_stadt_grenze</em> der Datenbank <em>backend</em> importiert. In der Datei <em>config.yml</em> wird die <acronym title="Uniform Resource Locator">URL</acronym> zum <acronym title="Web Feature Service">WFS</acronym> und die maximale Anzahl von Objekten, die der <acronym title="Web Feature Service">WFS</acronym> zurückgeben soll, angegeben. Der Typname bestimmt die Ebene, aus der die Grenzen ermittelt werden soll.</p><table><tr class="tableHeader"><td>Typname </td><td>Schlüssel </td></tr><tr><td>dvg:kreise </td><td>Kreisschlüssel z. B. 13074 Landkreis Nordwestmecklenburg </td></tr><tr><td>dvg:aemter </td><td>Amtsschlüssel ohne Kreisschlüssel z. B. statt 13072 5259 für Amt Neubukow-Salzhaff nur 5259 verwenden. Da eindeutig.</td></tr><tr><td>dvg:gemeinden </td><td>Gemeindeschlüssel z. B. 13074 069  für die Gemeinde Roggenstorf</td></tr></table><p>Zur Ermittlung eines Kreisschlüssels kann man den folgenden Link nutzen.</p><p><a href="http://www.geodaten-mv.de/dienste/dvg_laiv_wfs?SERVICE=WFS&amp;VERSION=1.1.0&amp;REQUEST=GetFeature&amp;TYPENAME=dvg:kreise&amp;maxFeatures=8">http://www.geodaten-mv.de/dienste/dvg_laiv_wfs?SERVICE=WFS&amp;VERSION=1.1.0&amp;REQUEST=GetFeature&amp;TYPENAME=dvg:kreise&amp;maxFeatures=8</a></p><p>Es wird eine XML-Datei zurückgegeben in der alle kreisfreien Städte und die Landkreise von MVP aufgeführt sind. Einen Gemeindeschlüssel kann man auch über den entsprechenden <strong>Wikipedia</strong>-Eintrag der Gemeinde finden.</p><p>Der <acronym title="Web Feature Service">WFS</acronym>-Import wird wie folgt aufgerufen:</p><pre><code>ruby import-wfs.rb
</code></pre><p>Die vom <acronym title="Web Feature Service">WFS</acronym> gelieferten Vektordaten werden in der Datenbank gespeichert.</p><h3 id="bewirtschafter">5. Bewirtschafter</h3><p>Soll der Zuständigkeitsfinder genutzt werden ist ein Import von Amtsflächen möglich. Die Konfiguration des Imports wird in der Datei <em>config.yml</em> durchgeführt. Die entsprechenden Amtsflächen sind dort zu aktivieren. Der Typname ist <code>dvg:aemter</code>. Dieser ist fest. Die Vektordaten werden in der Tabelle <em>bewirtschaftung</em> der Datenbank <em>zufi</em> gespeichert.</p><h2 id="administration">Administration</h2><p>Angemeldete Nutzer mit der Rolle <strong><em>admin</em></strong> können mit Klick auf die Schaltfläche <strong><em>Administration</em></strong> in den Bereich <em>Administration</em> des <strong>Backends</strong> wechseln.</p><p><img style="width:90%;padding:10px;background-color:#ffffff" border="0" src="img_Registerkarte_Uebersicht.png"/></p><p class="imgtext"><em>Abbildung:</em> Registerkarte <em>Übersicht</em></p><p>Mit Klick auf einen Reiter einer Registerkarte wird diese geöffnet. Auf der Registerkarte <em>Benutzer</em> findet man alle registrierten Nutzer des <strong>Backends</strong>. Von jedem Nutzer werden die entsprechenden Berechtigungen angezeigt</p><p><img style="width:90%;padding:10px;background-color:#ffffff" border="0" src="img_Registerkarte_Benutzer.png"/></p><p class="imgtext"><em>Abbildung:</em> Registerkarte <em>Benutzer</em></p><p>Auf der Registerkarte <em>Rollen</em> werden die Gruppen einer Organisation in ihren Rollen abgebildet. Dabei wird unterschieden zwischen den Rollen <em>intern</em>, <em>extern</em> und <em>aussendienst</em>.</p><p><img style="width:90%;padding:10px;background-color:#ffffff" border="0" src="img_Registerkarte_Rollen.png"/></p><p class="imgtext"><em>Abbildung:</em> Registerkarte <em>Rollen</em></p><p>Auf der Registerkarte <em>Außendienst</em> erfolgt die Darstellung der Außendienstkoordinatoren und der Gruppen für den Außendienst.</p><p><img style="width:90%;padding:10px;background-color:#ffffff" border="0" src="img_Registerkarte_Aussendienst.png"/></p><p class="imgtext"><em>Abbildung:</em> Registerkarte <em>Außendienst</em></p><p>Auf der Registerkarte <em>Redaktion</em> erfolgt die Darstellung der definierten Redaktionskriterien und der Empfänger der E-Mails, welche aufgrund der festgelegten Kriterien versendet werden. Die Redaktionskriterien können zum Zeitpunkt der Erstellung dieser Dokumentation nur mit datenbanktechnischen Mitteln definiert werden. Es wird hier die Behandlung von Meldungen definiert. Die Empfänger der redaktionellen E-Mails erhalten entsprechend der eingestellten Stufe nach einer definierten Anzahl von Tagen eine E-Mail über den Bearbeitungsstand einer Meldung die in ihren Zuständigkeitsbereich fallen.</p><p><img style="width:90%;padding:10px;background-color:#ffffff" border="0" src="img_Registerkarte_Redaktion.png"/></p><p class="imgtext"><em>Abbildung:</em> Registerkarte <em>Redaktion</em></p><p>Auf der Registerkarte <em>Lob/Hinweise/Kritik</em> werden die Texte angezeigt die im Frontend an einer vorhandenen Meldung unter <em>Details</em> -&gt; <em>Lob, Hinweise oder Kritik zur Meldung</em> von einem Nutzer erfasst werden. Mit Klick in die Spaltenbezeichnung kann die Tabelle nach dem Inhalt der entsprechenden Spalte auf oder absteigend sortiert werden.</p><p><img style="width:90%;padding:10px;background-color:#ffffff" border="0" src="img_Registerkarte_Lob.png"/></p><p class="imgtext"><em>Abbildung:</em> Registerkarte <em>Lob/Hinweise/Kritik</em></p><p>Auf der Registerkarte <em>Trashmail</em> besteht die Möglichkeit eine Liste von Domains anzupassen, die durch <strong>Klarschiff</strong> geblockt werden sollen. Damit wird der Missbrauch des Systems eingeschränkt. E-Mails mit diesen Domains werden blockiert und eine Einstellung von Vorgängen, Unterstützungen und Missbrauchsmeldungen sind damit nicht möglich.</p><p><img style="width:90%;padding:10px;background-color:#ffffff" border="0" src="img_Registerkarte_Trashmail.png"/></p><p class="imgtext"><em>Abbildung:</em> Registerkarte <em>Trashmail</em></p><p>Die Registerkarte <em>Status</em> gibt Auskunft über den gegenwärtigen Zustand des Servers. Neben den allgemeinen Angaben wie Hostname und IP-Adresse werden die Server im Cluster, der Status des <acronym title="Web Feature Service">WFS</acronym> und der Zustand der im Hintergrund laufenden Jobs angezeigt. Fehlerhafte Jobs werden in einer Tabelle angezeigt.</p><p><img style="width:90%;padding:10px;background-color:#ffffff" border="0" src="img_Registerkarte_Status.png"/></p><p class="imgtext"><em>Abbildung:</em> Registerkarte <em>Status</em></p><p>Auf der Registerkarte <em>Datenbank</em> befinden sich die Schaltflächen zum Anlegen der relevanten Datenbankobjekte der Frontend-Datenbank und zum Anlegen der Funktionen für die automatische Synchronisation der Daten aus der Backend-Datenbank in die Frontend-Datenbank. Diese Aufgaben müssen nur einmal nach der Installation oder nach Fehlern in der Frontend-Datenbank ausgeführt werden.</p><p><img style="width:90%;padding:10px;background-color:#ffffff" border="0" src="img_Registerkarte_Datenbank.png"/></p><p class="imgtext"><em>Abbildung:</em> Registerkarte <em>Datenbank</em></p></body></html>